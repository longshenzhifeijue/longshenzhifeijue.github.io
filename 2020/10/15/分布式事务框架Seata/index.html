

<!DOCTYPE html>
<html lang="en" color-mode=light>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>分布式事务框架Seata - Hexo</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="google" content="notranslate" />
  
  <meta name="description" content="分布式事务框架Seata

Seatahttp://s...">
  <meta name="author" content="John Doe">
  <link rel="icon" href="/images/icons/favicon-16x16.png" type="image/png" sizes="16x16">
  <link rel="icon" href="/images/icons/favicon-32x32.png" type="image/png" sizes="32x32">
  <link rel="apple-touch-icon" href="/images/icons/apple-touch-icon.png" sizes="180x180">
  <meta rel="mask-icon" href="/images/icons/stun-logo.svg" color="#333333">
  
    <meta rel="msapplication-TileImage" content="/images/icons/favicon-144x144.png">
    <meta rel="msapplication-TileColor" content="#000000">
  

  
<link rel="stylesheet" href="/css/style.css">


  
    
<link rel="stylesheet" href="//at.alicdn.com/t/font_1445822_r673sha78lq.css">

  

  
    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css">

  

  
    
      
        
        
<link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.18.1/styles/xcode.min.css" name="highlight-style" mode="light">

      
        
        
<link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.18.1/styles/solarized-dark.min.css" name="highlight-style" mode="dark">

      
  

  <script>
    var CONFIG = window.CONFIG || {};
    var ZHAOO = window.ZHAOO || {};
    CONFIG = {
      isHome: false,
      fancybox: true,
      pjax: false,
      lazyload: {
        enable: false,
        only_post: 'false',
        loading: '[object Object]'
      },
      donate: {
        enable: true,
        alipay: 'https://pic.izhaoo.com/alipay.jpg',
        wechat: 'https://pic.izhaoo.com/wechat.jpg'
      },
      galleries: {
        enable: true
      },
      fab: {
        enable: true,
        always_show: false
      },
      carrier: {
        enable: true
      },
      daovoice: {
        enable: false
      },
      preview: {
        background: {
          default: '',
          api: ''
        },
        motto: {
          default: '真正的大师，永远怀着一颗学徒的心',
          typing: false,
          api: '',
          data_contents: '["data","content"]'
        },
      },
      qrcode: {
        enable: true,
        type: 'url',
        image: 'https://pic.izhaoo.com/weapp-code.jpg',
      },
      toc: {
        enable: true
      },
      scrollbar: {
        type: 'default'
      },
      notification: {
        enable: false,
        delay: 4500,
        list: '',
        page_white_list: '',
        page_black_list: ''
      },
      search: {
        enable: false,
        path: ''
      }
    }
  </script>

  

  

<meta name="generator" content="Hexo 5.4.0"></head>

<body class="lock-screen">
  <div class="loading"></div>
  
    


  <nav class="navbar">
    <div class="left">
      
        <i class="iconfont iconhome j-navbar-back-home"></i>
      
      
        <i class="iconfont iconqrcode j-navbar-qrcode"></i>
      
      
        <i class="iconfont iconmoono" id="color-toggle" color-toggle="light"></i>
      
      
    </div>
    <div class="center">分布式事务框架Seata</div>
    <div class="right">
      <i class="iconfont iconmenu j-navbar-menu"></i>
    </div>
    
      <div id="qrcode-navbar"></div>
    
  </nav>

  
  

<nav class="menu">
  <div class="menu-container">
    <div class="menu-close">
      <i class="iconfont iconbaseline-close-px"></i>
    </div>
    <ul class="menu-content"><li class="menu-item">
        <a href="/ " class="underline "> 首页</a>
      </li><li class="menu-item">
        <a href="/galleries/ " class="underline "> 摄影</a>
      </li><li class="menu-item">
        <a href="/archives/ " class="underline "> 归档</a>
      </li><li class="menu-item">
        <a href="/tags/ " class="underline "> 标签</a>
      </li><li class="menu-item">
        <a href="/categories/ " class="underline "> 分类</a>
      </li><li class="menu-item">
        <a href="/about/ " class="underline "> 关于</a>
      </li></ul>
    
      <div class="menu-copyright"><p>Powered by <a target="_blank" href="https://hexo.io">Hexo</a>  |  Theme - <a target="_blank" href="https://github.com/longshenzhifeijue">XuFei</a></p></div>
    
  </div>
</nav>
  <main id="main">
  <div class="article-wrap">
    <div class="row container">
      <div class="col-xl-3"></div>
      <div class="col-xl-6"><article class="article">
  <div class="wrap">
    <section class="head">
  <img src="/images/theme/post-image.jpg" draggable="false">
  <div class="head-mask">
    <h1 class="head-title">分布式事务框架Seata</h1>
    <div class="head-info">
      <span class="post-info-item"><i class="iconfont iconcalendar"></i>October 15, 2020</span>
      
      <span class="post-info-item"><i class="iconfont iconfont-size"></i>6899</span>
    </div>
  </div>
</section>
    <section class="main">
      <section class="content">
        <h2 id="Seata"><a href="#Seata" class="headerlink" title="Seata"></a>Seata</h2><p><code>http://seata.io/zh-cn/</code><br>Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。本教程旨在为读者提供一个快速入门seata的案例，详细使用请参考官方案例和文档<br><img src="http://xmt.ssluxury.cn/seata12.png" alt="img"></p>
<h2 id="一个典型对分布式事物过程"><a href="#一个典型对分布式事物过程" class="headerlink" title="一个典型对分布式事物过程"></a>一个典型对分布式事物过程</h2><h3 id="1-3"><a href="#1-3" class="headerlink" title="1+3"></a>1+3</h3><p><img src="http://xmt.ssluxury.cn/image-20200913145454134.png" alt="image-20200913145454134"><br><img src="http://xmt.ssluxury.cn/image-20200913145521192.png" alt="image-20200913145521192"></p>
<h3 id="处理过程"><a href="#处理过程" class="headerlink" title="处理过程"></a>处理过程</h3><p><img src="http://xmt.ssluxury.cn/image-20200913145725895.png" alt="image-20200913145725895"></p>
<h2 id="seata-server搭建"><a href="#seata-server搭建" class="headerlink" title="seata-server搭建"></a>seata-server搭建</h2><p>在seata中，事务管理器是单独的一个服务，无需读者做二次开发，开箱即用。下载地址<a target="_blank" rel="noopener" href="https://github.com/seata/seata/releases">https://github.com/seata/seata/releases</a> 。本文案例中使用1.2.0这个版本。下载完成并解压后，需要对seata-server进行配置，需要配置conf目录下的file.conf和registry.conf。</p>
<p>其中file.conf是配置seata-server的数据存储方式，支持本地文档和数据库，本文直接使用本地文件存储。配置如下：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-comment">## transaction log store, only used in seata-server</span><br>store &#123;<br>  <span class="hljs-comment">## store mode: file、db</span><br>  <span class="hljs-attr">mode</span> = <span class="hljs-string">&quot;file&quot;</span><br><br>  <span class="hljs-comment">## file store property</span><br>  file &#123;<br>    <span class="hljs-comment">## store location dir</span><br>    <span class="hljs-attr">dir</span> = <span class="hljs-string">&quot;sessionStore&quot;</span><br>    <span class="hljs-comment"># branch session size , if exceeded first try compress lockkey, still exceeded throws exceptions</span><br>    <span class="hljs-attr">maxBranchSessionSize</span> = <span class="hljs-number">16384</span><br>    <span class="hljs-comment"># globe session size , if exceeded throws exceptions</span><br>    <span class="hljs-attr">maxGlobalSessionSize</span> = <span class="hljs-number">512</span><br>    <span class="hljs-comment"># file buffer size , if exceeded allocate new buffer</span><br>    <span class="hljs-attr">fileWriteBufferCacheSize</span> = <span class="hljs-number">16384</span><br>    <span class="hljs-comment"># when recover batch read size</span><br>    <span class="hljs-attr">sessionReloadReadSize</span> = <span class="hljs-number">100</span><br>    <span class="hljs-comment"># async, sync</span><br>    <span class="hljs-attr">flushDiskMode</span> = async<br>  &#125;<br><br>  <span class="hljs-comment">## database store property</span><br>  db &#123;<br>    <span class="hljs-comment">## the implement of javax.sql.DataSource, such as DruidDataSource(druid)/BasicDataSource(dbcp) etc.</span><br>    <span class="hljs-attr">datasource</span> = <span class="hljs-string">&quot;druid&quot;</span><br>    <span class="hljs-comment">## mysql/oracle/postgresql/h2/oceanbase etc.</span><br>    <span class="hljs-attr">dbType</span> = <span class="hljs-string">&quot;mysql&quot;</span><br>    <span class="hljs-attr">driverClassName</span> = <span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span><br>    <span class="hljs-attr">url</span> = <span class="hljs-string">&quot;jdbc:mysql://127.0.0.1:3306/seata&quot;</span><br>    <span class="hljs-attr">user</span> = <span class="hljs-string">&quot;mysql&quot;</span><br>    <span class="hljs-attr">password</span> = <span class="hljs-string">&quot;mysql&quot;</span><br>    <span class="hljs-attr">minConn</span> = <span class="hljs-number">5</span><br>    <span class="hljs-attr">maxConn</span> = <span class="hljs-number">30</span><br>    <span class="hljs-attr">globalTable</span> = <span class="hljs-string">&quot;global_table&quot;</span><br>    <span class="hljs-attr">branchTable</span> = <span class="hljs-string">&quot;branch_table&quot;</span><br>    <span class="hljs-attr">lockTable</span> = <span class="hljs-string">&quot;lock_table&quot;</span><br>    <span class="hljs-attr">queryLimit</span> = <span class="hljs-number">100</span><br>    <span class="hljs-attr">maxWait</span> = <span class="hljs-number">5000</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>registry.conf是配置seata-server的注册中心的，本文案例注册到eureka上。</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs nix">registry &#123;<br>  <span class="hljs-comment"># file 、nacos 、eureka、redis、zk、consul、etcd3、sofa</span><br>  <span class="hljs-attr">type</span> = <span class="hljs-string">&quot;eureka&quot;</span><br><br>  nacos &#123;<br>    <span class="hljs-attr">application</span> = <span class="hljs-string">&quot;seata-server&quot;</span><br>    <span class="hljs-attr">serverAddr</span> = <span class="hljs-string">&quot;localhost&quot;</span><br>    <span class="hljs-attr">namespace</span> = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">cluster</span> = <span class="hljs-string">&quot;default&quot;</span><br>    <span class="hljs-attr">username</span> = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">password</span> = <span class="hljs-string">&quot;&quot;</span><br>  &#125;<br>  eureka &#123;<br>    <span class="hljs-attr">serviceUrl</span> = <span class="hljs-string">&quot;http://localhost:8761/eureka&quot;</span><br>    <span class="hljs-attr">application</span> = <span class="hljs-string">&quot;default&quot;</span><br>    <span class="hljs-attr">weight</span> = <span class="hljs-string">&quot;1&quot;</span><br>  &#125;<br>  redis &#123;<br>    <span class="hljs-attr">serverAddr</span> = <span class="hljs-string">&quot;localhost:6379&quot;</span><br>    <span class="hljs-attr">db</span> = <span class="hljs-number">0</span><br>    <span class="hljs-attr">password</span> = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">cluster</span> = <span class="hljs-string">&quot;default&quot;</span><br>    <span class="hljs-attr">timeout</span> = <span class="hljs-number">0</span><br>  &#125;<br>  zk &#123;<br>    <span class="hljs-attr">cluster</span> = <span class="hljs-string">&quot;default&quot;</span><br>    <span class="hljs-attr">serverAddr</span> = <span class="hljs-string">&quot;127.0.0.1:2181&quot;</span><br>    <span class="hljs-attr">sessionTimeout</span> = <span class="hljs-number">6000</span><br>    <span class="hljs-attr">connectTimeout</span> = <span class="hljs-number">2000</span><br>    <span class="hljs-attr">username</span> = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">password</span> = <span class="hljs-string">&quot;&quot;</span><br>  &#125;<br>  consul &#123;<br>    <span class="hljs-attr">cluster</span> = <span class="hljs-string">&quot;default&quot;</span><br>    <span class="hljs-attr">serverAddr</span> = <span class="hljs-string">&quot;127.0.0.1:8500&quot;</span><br>  &#125;<br>  etcd3 &#123;<br>    <span class="hljs-attr">cluster</span> = <span class="hljs-string">&quot;default&quot;</span><br>    <span class="hljs-attr">serverAddr</span> = <span class="hljs-string">&quot;http://localhost:2379&quot;</span><br>  &#125;<br>  sofa &#123;<br>    <span class="hljs-attr">serverAddr</span> = <span class="hljs-string">&quot;127.0.0.1:9603&quot;</span><br>    <span class="hljs-attr">application</span> = <span class="hljs-string">&quot;default&quot;</span><br>    <span class="hljs-attr">region</span> = <span class="hljs-string">&quot;DEFAULT_ZONE&quot;</span><br>    <span class="hljs-attr">datacenter</span> = <span class="hljs-string">&quot;DefaultDataCenter&quot;</span><br>    <span class="hljs-attr">cluster</span> = <span class="hljs-string">&quot;default&quot;</span><br>    <span class="hljs-attr">group</span> = <span class="hljs-string">&quot;SEATA_GROUP&quot;</span><br>    <span class="hljs-attr">addressWaitTime</span> = <span class="hljs-string">&quot;3000&quot;</span><br>  &#125;<br>  file &#123;<br>    <span class="hljs-attr">name</span> = <span class="hljs-string">&quot;file.conf&quot;</span><br>  &#125;<br>&#125;<br><br>config &#123;<br>  <span class="hljs-comment"># file、nacos 、apollo、zk、consul、etcd3</span><br>  <span class="hljs-attr">type</span> = <span class="hljs-string">&quot;file&quot;</span><br><br>  nacos &#123;<br>    <span class="hljs-attr">serverAddr</span> = <span class="hljs-string">&quot;localhost&quot;</span><br>    <span class="hljs-attr">namespace</span> = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">group</span> = <span class="hljs-string">&quot;SEATA_GROUP&quot;</span><br>    <span class="hljs-attr">username</span> = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">password</span> = <span class="hljs-string">&quot;&quot;</span><br>  &#125;<br>  consul &#123;<br>    <span class="hljs-attr">serverAddr</span> = <span class="hljs-string">&quot;127.0.0.1:8500&quot;</span><br>  &#125;<br>  apollo &#123;<br>    <span class="hljs-attr">appId</span> = <span class="hljs-string">&quot;seata-server&quot;</span><br>    <span class="hljs-attr">apolloMeta</span> = <span class="hljs-string">&quot;http://192.168.1.204:8801&quot;</span><br>    <span class="hljs-attr">namespace</span> = <span class="hljs-string">&quot;application&quot;</span><br>  &#125;<br>  zk &#123;<br>    <span class="hljs-attr">serverAddr</span> = <span class="hljs-string">&quot;127.0.0.1:2181&quot;</span><br>    <span class="hljs-attr">sessionTimeout</span> = <span class="hljs-number">6000</span><br>    <span class="hljs-attr">connectTimeout</span> = <span class="hljs-number">2000</span><br>    <span class="hljs-attr">username</span> = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">password</span> = <span class="hljs-string">&quot;&quot;</span><br>  &#125;<br>  etcd3 &#123;<br>    <span class="hljs-attr">serverAddr</span> = <span class="hljs-string">&quot;http://localhost:2379&quot;</span><br>  &#125;<br>  file &#123;<br>    <span class="hljs-attr">name</span> = <span class="hljs-string">&quot;file.conf&quot;</span><br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<h2 id="业务代码初始化"><a href="#业务代码初始化" class="headerlink" title="业务代码初始化"></a>业务代码初始化</h2><p><a target="_blank" rel="noopener" href="https://github.com/forezp/distributed-lab/tree/master/seata-sample">https://github.com/forezp/distributed-lab/tree/master/seata-sample</a></p>
<h2 id="项目介绍"><a href="#项目介绍" class="headerlink" title="项目介绍"></a>项目介绍</h2><p>下载完成后，项目工程的文件目录如下，一共有5个工程，分别为eureka(注册中心)、business（交易发生的服务）、storage（库存服务）、order（订单服务）、account（账户服务），其中seata-server和另外四个业务服务都需要向eureka注册。sql目录为初始化sql的脚本。项目的目录结构如下。</p>
<p>seata-sample<br>├── account<br>├── bussiness<br>├── eureka<br>├── order<br>├── pom.xml<br>├── sql<br>└── storag</p>
<h2 id="初始化sql"><a href="#初始化sql" class="headerlink" title="初始化sql"></a>初始化sql</h2><p>在数据库中创建seata的数据库，并导入在sql目录下的数据库脚本。</p>
<h2 id="配置更改"><a href="#配置更改" class="headerlink" title="配置更改"></a>配置更改</h2><p>在业务代码中引入seata的sdk后，需要配置file.conf和registry.conf，请查看源码中的代码。在application.properties中配置mysql的连接：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">spring.cloud.alibaba.seata.tx-service-group=my_test_tx_group<br>spring.datasource.url=jdbc:mysql:<span class="hljs-comment">//127.0.0.1:3306/seatatest?useSSL=false&amp;serverTimezone=UTC</span><br>spring.datasource.username=root<br>spring.datasource.password=<span class="hljs-number">123456</span><br></code></pre></td></tr></table></figure>
<h2 id="启动工程"><a href="#启动工程" class="headerlink" title="启动工程"></a>启动工程</h2><p>依次启动seata-server，euraka，business，storage，order，account工程。访问eureka的地址：<a target="_blank" rel="noopener" href="http://localhost:8761/">http://localhost:8761/</a> ，可以见到服务都向eureka注册。<br><img src="http://xmt.ssluxury.cn/image-20200811153002809.png" alt="image-20200811153002809"><br>在启动business服务时，会向数据库插入以下的数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initData</span><span class="hljs-params">()</span> </span>&#123;<br>        jdbcTemplate.update(<span class="hljs-string">&quot;delete from account_tbl&quot;</span>);<br>        jdbcTemplate.update(<span class="hljs-string">&quot;delete from order_tbl&quot;</span>);<br>        jdbcTemplate.update(<span class="hljs-string">&quot;delete from storage_tbl&quot;</span>);<br>        jdbcTemplate.update(<span class="hljs-string">&quot;insert into account_tbl(user_id,money) values(&#x27;U100000&#x27;,&#x27;10000&#x27;) &quot;</span>);<br>        jdbcTemplate.update(<span class="hljs-string">&quot;insert into storage_tbl(commodity_code,count) values(&#x27;C100000&#x27;,&#x27;200&#x27;) &quot;</span>);<br>    &#125;<br></code></pre></td></tr></table></figure>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>seata官方已经将代码逻辑写好了，直接测试即可。</p>
<blockquote>
<p>curl <a target="_blank" rel="noopener" href="http://127.0.0.1:8084/purchase/commit">http://127.0.0.1:8084/purchase/commit</a></p>
</blockquote>
<p>此接口代码逻辑如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(value = &quot;/purchase/commit&quot;, produces = &quot;application/json&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">purchaseCommit</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            businessService.purchase(<span class="hljs-string">&quot;U100000&quot;</span>, <span class="hljs-string">&quot;C100000&quot;</span>, <span class="hljs-number">30</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception exx) &#123;<br>            <span class="hljs-keyword">return</span> exx.getMessage();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;全局事务提交&quot;</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>即买30个库存，当前库存、金额都够，所以交易正常进行。</p>
<p>完成后可以看到数据库中 account_tbl的id为1的money会减少 5，order_tbl中会新增一条记录，storage_tbl的id为1的count字段减少 1</p>
<blockquote>
<p>2020-05-21 16:09:12.388 INFO [AsyncCommitting_1]io.seata.server.coordinator.DefaultCore.doGlobalCommit:240 -Committing global transaction is successfully done, xid = 10.66.40.141:8091:2012236512.</p>
</blockquote>
<h2 id="发生异常事务回滚"><a href="#发生异常事务回滚" class="headerlink" title="发生异常事务回滚"></a>发生异常事务回滚</h2><p>调用如下的接口:</p>
<blockquote>
<p>curl <a target="_blank" rel="noopener" href="http://127.0.0.1:8084/purchase/rollback">http://127.0.0.1:8084/purchase/rollback</a></p>
</blockquote>
<p>此接口代码逻辑如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/purchase/rollback&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">purchaseRollback</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            businessService.purchase(<span class="hljs-string">&quot;U100000&quot;</span>, <span class="hljs-string">&quot;C100000&quot;</span>, <span class="hljs-number">99999</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception exx) &#123;<br>            <span class="hljs-keyword">return</span> exx.getMessage();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;全局事务提交&quot;</span>;<br>    &#125;<br><br></code></pre></td></tr></table></figure>
<p>次接口先扣掉了库存，然后扣掉了钱，最后查询数据库，发现数据库的库存为负数，于是抛出异常，发生回滚，待完成后数据库中的数据没有发生变化，回滚成功。可见分布式事务回滚操作成功。</p>
<h2 id="启动业务服务"><a href="#启动业务服务" class="headerlink" title="启动业务服务"></a>启动业务服务</h2><p><img src="http://xmt.ssluxury.cn/image-20200811153301264.png" alt="image-20200811153301264"></p>
<h2 id="导入Sql"><a href="#导入Sql" class="headerlink" title="导入Sql"></a>导入Sql</h2><p><img src="http://xmt.ssluxury.cn/image-20200811153340463.png" alt="image-20200811153340463"></p>
<h2 id="启动Seata服务"><a href="#启动Seata服务" class="headerlink" title="启动Seata服务"></a>启动Seata服务</h2><p><img src="http://xmt.ssluxury.cn/image-20200811154928071.png" alt="image-20200811154928071"></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://www.fangzhipeng.com/architecture/2020/06/11/seata-test.html">https://www.fangzhipeng.com/architecture/2020/06/11/seata-test.html</a><br><a target="_blank" rel="noopener" href="http://seata.io/zh-cn/docs/overview/what-is-seata.html">http://seata.io/zh-cn/docs/overview/what-is-seata.html</a></p>
      </section>
      <section class="extra">
        
          <ul class="copyright">
  
    <li><strong>本文作者：</strong>John Doe</li>
    <li><strong>本文链接：</strong><a href="http://yoursite.com/2020/10/15/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%A1%86%E6%9E%B6Seata/index.html" title="http:&#x2F;&#x2F;yoursite.com&#x2F;2020&#x2F;10&#x2F;15&#x2F;%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%A1%86%E6%9E%B6Seata&#x2F;index.html">http:&#x2F;&#x2F;yoursite.com&#x2F;2020&#x2F;10&#x2F;15&#x2F;%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%A1%86%E6%9E%B6Seata&#x2F;index.html</a></li>
    <li><strong>版权声明：</strong>本博客所有文章均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" title="BY-NC-SA" target="_blank" rel="noopener">BY-NC-SA</a> 许可协议，转载请注明出处！</li>
  
</ul>
        
        
          <section class="donate">
  <div id="qrcode-donate">
    <img src="https://pic.izhaoo.com/alipay.jpg">
  </div>
  <div class="icon">
    <a href="javascript:;" id="alipay"><i class="iconfont iconalipay"></i></a>
    <a href="javascript:;" id="wechat"><i class="iconfont iconwechat-fill"></i></a>
  </div>
</section>
        
        
        
  <nav class="nav">
    <a href="/2020/10/20/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%8E%A7%E5%88%B6%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"><i class="iconfont iconleft"></i>微服务架构的分布式事务控制解决方案</a>
    <a href="/2020/10/15/01mysql/(%E5%9B%9B)Mysql-%E9%94%81%E6%9C%BA%E5%88%B6/">四、Mysql锁机制<i class="iconfont iconright"></i></a>
  </nav>

      </section>
      
    </section>
  </div>
</article></div>
      <div class="col-xl-3">
        
          
  <aside class="toc-wrap">
    <h3 class="toc-title">文章目录：</h3>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Seata"><span class="toc-text">Seata</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E5%85%B8%E5%9E%8B%E5%AF%B9%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E7%89%A9%E8%BF%87%E7%A8%8B"><span class="toc-text">一个典型对分布式事物过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3"><span class="toc-text">1+3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E8%BF%87%E7%A8%8B"><span class="toc-text">处理过程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#seata-server%E6%90%AD%E5%BB%BA"><span class="toc-text">seata-server搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">业务代码初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D"><span class="toc-text">项目介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96sql"><span class="toc-text">初始化sql</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%9B%B4%E6%94%B9"><span class="toc-text">配置更改</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%B7%A5%E7%A8%8B"><span class="toc-text">启动工程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-text">测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E7%94%9F%E5%BC%82%E5%B8%B8%E4%BA%8B%E5%8A%A1%E5%9B%9E%E6%BB%9A"><span class="toc-text">发生异常事务回滚</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E4%B8%9A%E5%8A%A1%E6%9C%8D%E5%8A%A1"><span class="toc-text">启动业务服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5Sql"><span class="toc-text">导入Sql</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8Seata%E6%9C%8D%E5%8A%A1"><span class="toc-text">启动Seata服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-text">参考资料</span></a></li></ol>
  </aside>

        
      </div>
    </div>
  </div>
</main>
  

<footer class="footer">
  <div class="footer-social"><a 
        href="tencent://message/?Menu=yes&uin=894519210 "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color= '#12B7F5'" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  iconQQ "></i>
      </a><a 
        href="javascript:; "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color= '#09BB07'" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  iconwechat-fill "></i>
      </a><a 
        href="https://github.com/longshenzhifeijue "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color= '#9f7be1'" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  icongithub-fill "></i>
      </a><a 
        href="mailto:xufei20160601@163.com "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color=#FF3B00" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  iconmail"></i>
      </a></div>
  
    <div class="footer-copyright"><p>Powered by <a target="_blank" href="https://hexo.io">Hexo</a>  |  Theme - <a target="_blank" href="https://github.com/longshenzhifeijue">XuFei</a></p></div>
  
</footer>
  
      <div class="fab fab-plus">
    <i class="iconfont iconplus"></i>
  </div>
  
  
  <div class="fab fab-up">
    <i class="iconfont iconcaret-up"></i>
  </div>
  
  
  
    
<script src="/js/color-mode.js"></script>

  
  
</body>

<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>



  
<script src="https://cdn.bootcdn.net/ajax/libs/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script>




  
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>






  
<script src="https://cdn.bootcdn.net/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>




<script src="/js/utils.js"></script>
<script src="/js/script.js"></script>







  <script>
    (function () {
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
      } else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>













</html>